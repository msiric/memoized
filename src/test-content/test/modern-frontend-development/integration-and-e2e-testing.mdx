# **Integration & E2E Testing**

This lesson covers advanced testing patterns, integration testing strategies, and end-to-end testing implementations.

## **Integration Testing Patterns**

### **Feature Integration Tests**

```typescript
// Feature test setup
interface TestContext {
  store: Store;
  history: History;
  utils: RenderResult;
}

const createTestContext = async (): Promise<TestContext> => {
  const store = configureStore({
    reducer: rootReducer,
    middleware: [...defaultMiddleware]
  });

  const history = createMemoryHistory();
  const utils = render(
    <Provider store={store}>
      <Router history={history}>
        <App />
      </Router>
    </Provider>
  );

  return { store, history, utils };
};

// Authentication flow test
describe('Authentication Flow', () => {
  let context: TestContext;

  beforeEach(async () => {
    context = await createTestContext();
  });

  it('completes login flow successfully', async () => {
    const { store, history } = context;

    // Navigate to login
    history.push('/login');

    // Fill in credentials
    await userEvent.type(
      screen.getByLabelText('Email'),
      'test@example.com'
    );
    await userEvent.type(
      screen.getByLabelText('Password'),
      'password123'
    );

    // Submit form
    await userEvent.click(screen.getByText('Login'));

    // Verify state changes
    await waitFor(() => {
      expect(store.getState().auth.isAuthenticated).toBe(true);
      expect(history.location.pathname).toBe('/dashboard');
    });

    // Verify UI updates
    expect(screen.getByText('Welcome back!')).toBeInTheDocument();
  });
});
```

### **API Integration Tests**

```typescript
// API integration setup
const createApiTestContext = () => {
  const apiClient = createApiClient()
  const mockServer = setupMockServer()

  return {
    apiClient,
    mockServer,
    async request(method: string, path: string, data?: any) {
      const response = await apiClient[method](path, data)
      return response
    },
  }
}

// API flow test
describe('User API Flow', () => {
  let context: ReturnType<typeof createApiTestContext>

  beforeEach(() => {
    context = createApiTestContext()
  })

  it('handles user creation and update flow', async () => {
    const { request } = context

    // Create user
    const createResponse = await request('post', '/users', {
      name: 'John Doe',
      email: 'john@example.com',
    })

    expect(createResponse.status).toBe(201)
    const userId = createResponse.data.id

    // Update user
    const updateResponse = await request('put', `/users/${userId}`, {
      name: 'John Updated',
    })

    expect(updateResponse.status).toBe(200)
    expect(updateResponse.data.name).toBe('John Updated')

    // Verify user
    const getResponse = await request('get', `/users/${userId}`)
    expect(getResponse.data.name).toBe('John Updated')
  })
})
```

## **E2E Testing with Cypress**

### **Page Object Pattern**

```typescript
// cypress/support/pages/login.page.ts
class LoginPage {
  private selectors = {
    emailInput: '[data-testid="email-input"]',
    passwordInput: '[data-testid="password-input"]',
    submitButton: '[data-testid="login-submit"]',
    errorMessage: '[data-testid="error-message"]',
  }

  visit() {
    cy.visit('/login')
    return this
  }

  fillEmail(email: string) {
    cy.get(this.selectors.emailInput).type(email)
    return this
  }

  fillPassword(password: string) {
    cy.get(this.selectors.passwordInput).type(password)
    return this
  }

  submit() {
    cy.get(this.selectors.submitButton).click()
    return this
  }

  getErrorMessage() {
    return cy.get(this.selectors.errorMessage)
  }

  login(email: string, password: string) {
    return this.visit().fillEmail(email).fillPassword(password).submit()
  }
}

// cypress/integration/auth.spec.ts
describe('Authentication', () => {
  const loginPage = new LoginPage()

  beforeEach(() => {
    cy.clearCookies()
    cy.clearLocalStorage()
  })

  it('successfully logs in', () => {
    loginPage.login('test@example.com', 'password123').then(() => {
      cy.url().should('include', '/dashboard')
      cy.get('[data-testid="user-menu"]').should('contain', 'test@example.com')
    })
  })
})
```

### **Custom Commands**

```typescript
// cypress/support/commands.ts
declare global {
  namespace Cypress {
    interface Chainable {
      login(email: string, password: string): Chainable<void>
      seedDatabase(data: any): Chainable<void>
      mockApi(path: string, response: any): Chainable<void>
    }
  }
}

Cypress.Commands.add('login', (email, password) => {
  cy.request({
    method: 'POST',
    url: '/api/login',
    body: { email, password },
  }).then((response) => {
    window.localStorage.setItem('auth_token', response.body.token)
  })
})

Cypress.Commands.add('seedDatabase', (data) => {
  cy.request({
    method: 'POST',
    url: '/api/test/seed',
    body: data,
  })
})

Cypress.Commands.add('mockApi', (path, response) => {
  cy.intercept(path, response)
})

// Usage in tests
describe('Dashboard', () => {
  beforeEach(() => {
    cy.seedDatabase({
      users: [{ id: 1, name: 'Test User' }],
      posts: [{ id: 1, title: 'Test Post' }],
    })
    cy.login('test@example.com', 'password123')
  })

  it('displays user posts', () => {
    cy.visit('/dashboard')
    cy.get('[data-testid="post-list"]').should('contain', 'Test Post')
  })
})
```

## **Visual Regression Testing**

### **Storybook Integration**

```typescript
// .storybook/test-runner.ts
import { TestRunnerConfig } from '@storybook/test-runner';
import { toMatchImageSnapshot } from 'jest-image-snapshot';

const config: TestRunnerConfig = {
  setup() {
    expect.extend({ toMatchImageSnapshot });
  },
  async postRender(page, context) {
    const image = await page.screenshot();
    expect(image).toMatchImageSnapshot({
      customSnapshotsDir: `__image_snapshots__/${context.id}`,
      customDiffConfig: {
        threshold: 0.1
      }
    });
  }
};

// Component story with visual testing
import { Story } from '@storybook/react';
import { Card } from './Card';

export default {
  title: 'Components/Card',
  component: Card
};

const Template: Story = (args) => <Card {...args} />;

export const Default = Template.bind({});
Default.args = {
  title: 'Test Card',
  description: 'This is a test card'
};

export const WithImage = Template.bind({});
WithImage.args = {
  ...Default.args,
  image: 'https://example.com/image.jpg'
};

// Visual regression test
describe('Card Component', () => {
  it('matches visual snapshot', async () => {
    await page.goto(
      `http://localhost:6006/iframe.html?id=components-card--default`
    );
    const image = await page.screenshot();
    expect(image).toMatchImageSnapshot();
  });
});
```

## **Test Architecture**

### **Test Environment Setup**

```typescript
// test/setup/environment.ts
class TestEnvironment {
  private static instance: TestEnvironment
  private server: TestServer
  private database: TestDatabase

  private constructor() {
    this.server = new TestServer()
    this.database = new TestDatabase()
  }

  static getInstance() {
    if (!TestEnvironment.instance) {
      TestEnvironment.instance = new TestEnvironment()
    }
    return TestEnvironment.instance
  }

  async setup() {
    await this.database.connect()
    await this.server.start()
  }

  async teardown() {
    await this.server.stop()
    await this.database.disconnect()
  }

  async resetState() {
    await this.database.reset()
  }
}

// Global setup
beforeAll(async () => {
  const env = TestEnvironment.getInstance()
  await env.setup()
})

afterAll(async () => {
  const env = TestEnvironment.getInstance()
  await env.teardown()
})

beforeEach(async () => {
  const env = TestEnvironment.getInstance()
  await env.resetState()
})
```

### **Test Data Management**

```typescript
// test/fixtures/index.ts
class TestDataManager {
  private static data = new Map<string, any>()

  static async load(fixture: string) {
    if (!this.data.has(fixture)) {
      const data = await import(`./fixtures/${fixture}.json`)
      this.data.set(fixture, data)
    }
    return this.data.get(fixture)
  }

  static create<T>(factory: string, overrides?: Partial<T>): T {
    const baseData = this.data.get(factory)
    return { ...baseData, ...overrides }
  }
}

// Factory patterns
const createTestUser = (overrides = {}) => ({
  id: faker.datatype.uuid(),
  name: faker.name.findName(),
  email: faker.internet.email(),
  ...overrides,
})

const createTestPost = (overrides = {}) => ({
  id: faker.datatype.uuid(),
  title: faker.lorem.sentence(),
  content: faker.lorem.paragraphs(),
  ...overrides,
})
```

## **CI/CD Integration**

### **Test Pipeline Configuration**

```typescript
// github-actions-config.yml
name: Test Pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

      - name: Run E2E tests
        uses: cypress-io/github-action@v2
        with:
          build: npm run build
          start: npm start
          wait-on: 'http://localhost:3000'

      - name: Upload test coverage
        uses: codecov/codecov-action@v2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

// jest.config.ci.js
module.exports = {
  ...require('./jest.config'),
  collectCoverage: true,
  coverageReporters: ['json', 'lcov', 'text', 'clover'],
  maxWorkers: 2
};
```

## **Interview Questions**

1. "How would you design a comprehensive testing strategy for a large application?"
2. "What's your approach to managing test data in E2E tests?"
3. "How would you implement visual regression testing in a CI pipeline?"
4. "Explain the trade-offs between different types of integration tests."
5. "How would you handle flaky tests in a CI environment?"
6. "What strategies would you use for testing real-time features?"

## **Practice Problems**

1. Implement an E2E test suite for an authentication flow
2. Create a visual regression testing setup for a component library
3. Build a test data management system
4. Implement a CI pipeline for running different types of tests

## **Additional Resources**

- [Cypress Best Practices](https://docs.cypress.io/guides/references/best-practices)
- [Testing Library Integration Testing](https://testing-library.com/docs/react-testing-library/example-intro)
- [Visual Regression Testing with Jest](https://jestjs.io/docs/snapshot-testing)

Would you like me to:

1. Add more practical examples?
2. Include more interview questions?
3. Add more implementation patterns?
4. Create more practice problems?
